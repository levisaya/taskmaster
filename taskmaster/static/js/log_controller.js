// Generated by CoffeeScript 1.8.0
(function() {
  angular.module('taskmasterApp').controller('LogController', function($scope, $http, $timeout, $q) {
    $scope.last_log_time = 0.0;
    $scope.last_time_index = 0;
    $scope.log_buffer = [];
    $scope.subscribed = false;
    $scope.canceller = null;
    $scope.recv_logs = function(data) {
      Array.prototype.push.apply($scope.log_buffer, data.output);
      $scope.last_log_time = data.last_output_time;
      $scope.last_time_index = data.time_index;
      if ($scope.subscribed) {
        return $scope.subscribe_to_logs();
      }
    };
    $scope.unsubscribe_to_logs = function() {
      if ($scope.canceller != null) {
        $scope.canceller.resolve('');
      }
      $scope.log_buffer = [];
      $scope.last_log_time = 0.0;
      return $scope.last_time_index = 0;
    };
    $scope.$on("$destroy", $scope.unsubscribe_to_logs);
    $scope.subscribe_to_logs = function(delay) {
      var http_get;
      if (delay == null) {
        delay = 0;
      }
      $scope.canceller = $q.defer();
      http_get = function() {
        return $http.get('logs/streaming/' + $scope.$parent.$index + '/' + $scope.last_log_time.toFixed(2) + '/' + $scope.last_time_index, {
          timeout: $scope.canceller.promise
        }).success($scope.recv_logs).error(function() {
          if ($scope.subscribed) {
            return subscribe_to_logs(1000);
          }
        });
      };
      return $timeout(http_get, delay);
    };
    $scope.stop_start = function(event, process_index) {
      if (process_index === $scope.$parent.$index && $scope.subscribed === false) {
        $scope.subscribed = true;
        return $scope.subscribe_to_logs();
      } else if ($scope.subscribed) {
        $scope.subscribed = false;
        return $scope.unsubscribe_to_logs();
      }
    };
    $scope.$on('selected_process', $scope.stop_start);
  });

}).call(this);
